{% extends 'shop/basic.html' %}

{%block title%}  index {% endblock %}
{%block css%} 
<style>
img.card-img-top {

  height: 200px;
  width: auto;
}
</style>
{% endblock %}
{%block body%}

    {% for product, nSlides in allProds %}
    
    
    <div class="container">
    <h5 class="my-4">{{product.0.category}} - All Items</h5>
      <div class="row">
        {%for i in product%}
        <div class="col-md-3">
          <div class="card" style="width: 18rem;">
            <img src='/media/{{i.image}}' class="card-img-top" alt="phone">
            <div class="card-body">
              <h5 class="card-title" id="namepr{{i.id}}">{{i.product_name}}</h5>
              <p class="card-text">{{i.category}}</p>
              <p class="card-text">{{i.price}}tk</p>
              <span id="divpr{{i.id}}" class="divpr">
              <button id="pr{{i.id}}" class="btn btn-primary cart">Add to Cart</button>
              </span>
              <a href="/shop/products/{{i.id}}"><button id="qv{{i.id}}" class="btn btn-primary cart">Quick View</button></a>
            </div>
          </div>
        </div>
        {%endfor%}
        
      </div>
      
    </div>
    {%endfor%}
    {% endblock %}
    {%block js%}
    <script>
      // Find out the cart items from localStorage

      if(localStorage.getItem('cart') == null){
      var cart = {};
      }
      else
      {
      cart = JSON.parse(localStorage.getItem('cart'));
      document.getElementById('cart').innerHTML = Object.keys(cart).length
      updateCart(cart);
      }
      // If the add to cart button is clicked, add/increment the item

      $('.cart').click(function(){
      console.log('clicked');
      var idstr= this.id.toString();
      console.log(idstr);
      if(cart[idstr]!= undefined) {
      cart[idstr] = cart[idstr]+1;
      }
      else{
      cart[idstr] = 1;
      }
      updateCart(cart);
      });
      //pop over
      const popoverTriggerList = document.querySelectorAll('[data-bs-toggle="popover"]')
      const popoverList = [...popoverTriggerList].map(popoverTriggerEl => new bootstrap.Popover(popoverTriggerEl))
      updatePopover(cart);
      function updatePopover(cart)
      {
        var popStr="";
        var i=1;
        for(var item in cart)
        {
          popStr = popStr + '<b>'+ i+'</b> .';
          popStr = popStr + document.getElementById('name'+
          item).innerHTML+ " qty: " + cart[item] + '<br>';
          i++;
        }
        const popoverTriggerList = document.querySelectorAll('[data-bs-toggle="popover"]')
        console.log(popStr);
        document.getElementById('popcart').setAttribute('data-bs-content', popStr);
      const popoverList = [...popoverTriggerList].map(popoverTriggerEl => new bootstrap.Popover(popoverTriggerEl))

      }
      function updateCart(cart)
      {
        for(var item in cart)
        {
            document.getElementById('div' + item).innerHTML = "<button id='minus" + item + "' class='btn btn-primary minus'>-</button> <span id='val" + item + "''>" + cart[item] + "</span> <button id='plus" + item + "' class='btn btn-primary plus'> + </button>";

        }
        localStorage.setItem('cart', JSON.stringify(cart));
        document.getElementById('cart').innerHTML = Object.keys(cart).length;
      }
// If plus or minus button is clicked, change the cart as well as the display value

      $('.divpr').on("click","button.minus",function()
      {
        console.log("Minus Click")
        a=this.id.slice(7, );
        cart['pr'+a]=cart['pr'+a]-1;
        cart['pr' + a] = Math.max(0, cart['pr' + a]);
        document.getElementById('valpr'+a).innerHTML= cart['pr'+a];
        updateCart(cart)
      })
      $('.divpr').on("click","button.plus",function()
      {
        a=this.id.slice(6, );
        cart['pr'+a]=cart['pr'+a]+1;
        document.getElementById('valpr'+a).innerHTML= cart['pr'+a];
        updateCart(cart)
      })

    </script>
     {% endblock %}
  </body>
</html>